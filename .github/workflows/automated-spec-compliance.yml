name: ğŸš¨ AUTOMATED SPEC COMPLIANCE ENFORCEMENT

on:
  push:
    branches: [ main, develop ]
    paths: 
      - '02-requirements/**/*.md'
      - '03-architecture/**/*.md' 
      - '04-design/**/*.md'
      - '**/*spec*.md'
      - '**/*specification*.md'
      - '**/*architecture*.md'
  pull_request:
    branches: [ main ]
    paths:
      - '02-requirements/**/*.md'
      - '03-architecture/**/*.md'
      - '04-design/**/*.md'
      - '**/*spec*.md'
      - '**/*specification*.md' 
      - '**/*architecture*.md'

jobs:
  automated-compliance-enforcement:
    name: ğŸ¤– Automated Compliance Validation & Auto-Fix
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for comprehensive validation
        
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        pip install --upgrade pip
        pip install pyyaml jsonschema
        
    - name: ğŸ” Run Automated Compliance Validation
      id: validation
      run: |
        echo "ğŸš¨ RUNNING AUTOMATED SPEC COMPLIANCE VALIDATION..."
        python Scripts/autofix-spec-compliance.py --check-only --verbose
      continue-on-error: true
      
    - name: ğŸ› ï¸ Auto-Fix Non-Compliant Specifications
      if: steps.validation.outcome == 'failure'
      run: |
        echo "ğŸ¤– AUTO-FIXING NON-COMPLIANT SPECIFICATIONS..."
        python Scripts/autofix-spec-compliance.py --all --verbose
        
    - name: ğŸ“Š Generate Compliance Report
      run: |
        echo "ğŸ“Š GENERATING COMPLIANCE REPORT..."
        python Scripts/autofix-spec-compliance.py --check-only --all > compliance-report.txt || true
        cat compliance-report.txt
        
    - name: ğŸ·ï¸ Create Auto-Fix Commit (if needed)
      if: steps.validation.outcome == 'failure'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - Spec Compliance Bot"
        
        if [[ -n $(git status --porcelain) ]]; then
          echo "ğŸ¤– AUTO-FIXED SPECIFICATION COMPLIANCE ISSUES"
          git add .
          git commit -m "ğŸ¤– AUTO-FIX: Specification compliance violations
          
          - Fixed YAML front matter schema violations
          - Corrected enumeration values and ID formatting  
          - Added missing authoritative document references
          - Enforced consistent traceability requirements
          
          Automated by: Scripts/autofix-spec-compliance.py"
          
          echo "auto_fixed=true" >> $GITHUB_OUTPUT
        else
          echo "âœ… No auto-fixes needed"
          echo "auto_fixed=false" >> $GITHUB_OUTPUT
        fi
      id: auto_fix
        
    - name: ğŸš€ Push Auto-Fixes (if needed)
      if: steps.auto_fix.outputs.auto_fixed == 'true' && github.event_name == 'push'
      run: |
        git push origin ${{ github.ref_name }}
        echo "ğŸ‰ AUTO-FIXES PUSHED SUCCESSFULLY"
        
    - name: ğŸ”´ Fail CI if Auto-Fix Required on PR
      if: steps.auto_fix.outputs.auto_fixed == 'true' && github.event_name == 'pull_request'
      run: |
        echo "âŒ PULL REQUEST HAS SPECIFICATION COMPLIANCE VIOLATIONS!"
        echo ""
        echo "ğŸ› ï¸  REQUIRED ACTION:"
        echo "   1. Run: python Scripts/autofix-spec-compliance.py --all"
        echo "   2. Commit and push the auto-fixes"
        echo "   3. Re-submit the pull request"
        echo ""
        echo "ğŸ“‹ COMPLIANCE VIOLATIONS:"
        cat compliance-report.txt
        exit 1
        
    - name: ğŸ“„ Upload Compliance Report
      uses: actions/upload-artifact@v4
      with:
        name: specification-compliance-report
        path: compliance-report.txt
        retention-days: 30
        
    - name: ğŸ’¬ Comment on PR (if violations found)
      if: steps.validation.outcome == 'failure' && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('compliance-report.txt', 'utf8');
          
          const comment = `## ğŸš¨ Specification Compliance Violations Detected
          
          Your pull request contains specification files with compliance violations. 
          
          ### ğŸ› ï¸ Required Action
          
          Please run the automated fix script and commit the changes:
          
          \`\`\`bash
          python Scripts/autofix-spec-compliance.py --all
          git add .
          git commit -m "ğŸ¤– Fix specification compliance violations"
          git push
          \`\`\`
          
          ### ğŸ“‹ Detailed Report
          
          \`\`\`
          ${report}
          \`\`\`
          
          ### â„¹ï¸ What This Fixes
          
          - âœ… YAML front matter schema compliance
          - âœ… Correct enumeration values and ID formatting
          - âœ… Missing authoritative document references
          - âœ… Consistent traceability requirements format
          - âœ… Proper version numbering (semantic versioning)
          
          **This is automated quality enforcement - no manual editing required! ğŸ¤–**`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
    - name: âœ… Final Validation
      run: |
        echo "ğŸ RUNNING FINAL COMPLIANCE VALIDATION..."
        python Scripts/autofix-spec-compliance.py --check-only --all
        echo "ğŸ‰ ALL SPECIFICATIONS ARE COMPLIANT!"

  legacy-validation-compatibility:
    name: ğŸ”„ Legacy Validation (Compatibility)
    runs-on: ubuntu-latest
    needs: automated-compliance-enforcement
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        pip install pyyaml jsonschema
        
    - name: ğŸ”„ Run Legacy Validation (for comparison)
      run: |
        echo "ğŸ”„ Running legacy validation for comparison..."
        python Scripts/validate-spec-structure.py 03-architecture/ieee-cross-standard-integration-comprehensive-architecture.md || true
        echo "â„¹ï¸  Legacy validation complete (informational only)"